<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ContractOS ‚Äî TrustGraph Visualization</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3345;
    --text: #e1e4ed;
    --text2: #8b90a0;
    --accent: #6c5ce7;
    --accent2: #a29bfe;
    --green: #00b894;
    --orange: #fdcb6e;
    --red: #e17055;
    --blue: #74b9ff;
    --pink: #fd79a8;
    --teal: #00cec9;
    --yellow: #ffeaa7;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
  }

  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 10;
    position: relative;
  }
  .header h1 {
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent2), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header a {
    color: var(--text2);
    text-decoration: none;
    font-size: 13px;
  }
  .header a:hover { color: var(--text); }

  .controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-left: auto;
  }
  .controls label { font-size: 12px; color: var(--text2); }
  .controls select, .controls input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 8px;
    color: var(--text);
    font-size: 12px;
  }
  .controls button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 6px 16px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
  }
  .controls button:hover { background: var(--accent2); }

  .main-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    height: calc(100vh - 49px);
  }

  /* Graph canvas */
  #graph-container {
    position: relative;
    overflow: hidden;
  }
  svg { width: 100%; height: 100%; }

  /* Legend */
  .legend {
    position: absolute;
    bottom: 16px;
    left: 16px;
    background: rgba(26, 29, 39, 0.95);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 11px;
    display: flex;
    gap: 16px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }

  /* Stats bar */
  .stats-bar {
    position: absolute;
    top: 12px;
    left: 16px;
    background: rgba(26, 29, 39, 0.95);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 12px;
    display: flex;
    gap: 20px;
  }
  .stat { display: flex; flex-direction: column; align-items: center; }
  .stat-value { font-size: 20px; font-weight: 700; }
  .stat-label { font-size: 10px; color: var(--text2); text-transform: uppercase; }

  /* Side panel */
  .side-panel {
    background: var(--surface);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .side-panel h3 {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--accent2);
  }
  .side-panel .section-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 12px 0;
  }

  /* Upload section in side panel */
  .upload-section {
    padding: 12px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 4px;
  }
  .upload-section .file-drop {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    color: var(--text2);
    transition: all 0.15s;
    margin-bottom: 8px;
  }
  .upload-section .file-drop:hover { border-color: var(--accent); color: var(--text); }
  .upload-section .file-drop.has-file { border-color: var(--green); color: var(--green); border-style: solid; }
  .upload-section input[type="file"] { display: none; }
  .upload-section .upload-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 0;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
  }
  .upload-section .upload-btn:hover { background: var(--accent2); }
  .upload-section .upload-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .upload-section .or-divider {
    text-align: center;
    font-size: 11px;
    color: var(--text2);
    margin: 8px 0;
  }
  .upload-section .doc-id-row {
    display: flex;
    gap: 6px;
  }
  .upload-section .doc-id-row input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 8px;
    color: var(--text);
    font-family: monospace;
    font-size: 11px;
  }
  .upload-section .doc-id-row button {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
  }

  /* Q&A section */
  .qa-section textarea {
    width: 100%;
    min-height: 48px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px;
    color: var(--text);
    font-size: 12px;
    resize: vertical;
    font-family: inherit;
    margin-bottom: 6px;
  }
  .qa-section .ask-btn {
    background: var(--green);
    color: #000;
    border: none;
    padding: 8px 0;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    letter-spacing: 0.5px;
  }
  .qa-section .ask-btn:hover { opacity: 0.9; }
  .qa-section .ask-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Answer card */
  .answer-card {
    margin-top: 10px;
    padding: 12px;
    background: rgba(108,92,231,0.08);
    border: 1px solid rgba(108,92,231,0.2);
    border-radius: 8px;
  }
  .answer-card .answer-text {
    font-size: 13px;
    line-height: 1.65;
    margin-bottom: 8px;
  }
  .answer-card .answer-meta {
    font-size: 11px;
    color: var(--text2);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
  }
  .answer-card .answer-meta b { color: var(--text); }
  .badge-green { color: var(--green); font-weight: 700; }
  .badge-orange { color: var(--orange); font-weight: 700; }

  /* Provenance chain */
  .provenance-chain {
    margin-top: 10px;
  }
  .provenance-chain .chain-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--accent2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .provenance-node {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 6px 8px;
    border-left: 3px solid var(--green);
    margin-bottom: 4px;
    background: var(--surface2);
    border-radius: 0 6px 6px 0;
    cursor: pointer;
    transition: background 0.15s;
  }
  .provenance-node:hover { background: rgba(0,184,148,0.1); }
  .provenance-node.active { border-left-color: var(--yellow); background: rgba(255,234,167,0.08); }
  .provenance-node .prov-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }
  .provenance-node .prov-body { font-size: 11px; line-height: 1.5; }
  .provenance-node .prov-type { font-weight: 600; }
  .provenance-node .prov-summary { color: var(--text2); }
  .provenance-node .prov-location { font-size: 10px; color: var(--text2); margin-top: 2px; }

  .reasoning-box {
    margin-top: 8px;
    padding: 8px 10px;
    background: var(--surface2);
    border-radius: 6px;
    font-size: 11px;
    line-height: 1.6;
    color: var(--text2);
  }
  .reasoning-box b { color: var(--text); }

  /* Node detail */
  .node-detail { margin-bottom: 4px; }
  .node-detail .type-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 3px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .node-detail .label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    line-height: 1.4;
  }
  .node-detail .meta-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 11px;
    border-bottom: 1px solid var(--border);
  }
  .node-detail .meta-key { color: var(--text2); }
  .node-detail .meta-value { color: var(--text); font-family: monospace; font-size: 10px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }

  /* Traversal */
  .traversal-step {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
    font-size: 12px;
  }
  .traversal-step:hover { background: var(--surface2); margin: 0 -16px; padding: 6px 16px; }
  .traversal-step .step-icon {
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    flex-shrink: 0;
  }

  /* Algorithm panel */
  .algo-section { margin-bottom: 12px; }
  .algo-section h4 {
    font-size: 12px;
    font-weight: 600;
    color: var(--orange);
    margin-bottom: 4px;
  }
  .algo-section p {
    font-size: 11px;
    line-height: 1.6;
    color: var(--text2);
  }
  .algo-section code {
    background: var(--surface2);
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 10px;
    color: var(--green);
  }

  /* Pipeline viz */
  .pipeline {
    display: flex;
    flex-direction: column;
    gap: 3px;
    margin: 6px 0;
  }
  .pipeline-step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 8px;
    background: var(--surface2);
    border-radius: 4px;
    font-size: 10px;
    border-left: 3px solid var(--border);
  }
  .pipeline-step.active { border-left-color: var(--green); background: rgba(0, 184, 148, 0.08); }
  .pipeline-step .step-num {
    background: var(--accent);
    color: white;
    width: 16px; height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 700;
    flex-shrink: 0;
  }
  .pipeline-step .step-time {
    margin-left: auto;
    color: var(--green);
    font-family: monospace;
  }

  /* Tooltip */
  .tooltip {
    position: absolute;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 12px;
    pointer-events: none;
    z-index: 100;
    max-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text2);
    text-align: center;
    gap: 12px;
    padding: 40px;
  }
  .empty-state h2 { font-size: 20px; color: var(--text); }
  .empty-state p { font-size: 13px; max-width: 400px; line-height: 1.6; }

  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  .pulse { animation: pulse 1.5s ease-in-out infinite; }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<div class="header">
  <h1>ContractOS</h1>
  <span style="color: var(--text2); font-size: 11px; border: 1px solid var(--border); padding: 2px 8px; border-radius: 3px;">TrustGraph</span>
  <a href="/demo/">Demo Console</a>
  <a href="/demo/copilot.html" style="color: var(--green);">Copilot</a>
  <span id="docBadge" style="display: none; font-size: 11px; font-family: monospace; color: var(--green); background: rgba(0,184,148,0.1); padding: 3px 10px; border-radius: 4px;"></span>
  <div class="controls">
    <label>Filter:</label>
    <select id="filterType" onchange="applyFilter()">
      <option value="all">All Nodes</option>
      <option value="clause">Clauses Only</option>
      <option value="fact">Facts Only</option>
      <option value="binding">Bindings Only</option>
      <option value="cross_reference">Cross-Refs Only</option>
      <option value="no-clause-text">Hide Clause Text</option>
    </select>
    <label>Layout:</label>
    <select id="layoutType" onchange="changeLayout()">
      <option value="force">Force-Directed</option>
      <option value="radial">Radial</option>
      <option value="hierarchy">Hierarchy</option>
    </select>
    <button onclick="resetView()">Reset View</button>
  </div>
</div>

<div class="main-layout">
  <div id="graph-container">
    <!-- Empty state shown when no document loaded -->
    <div class="empty-state" id="emptyState">
      <div style="font-size: 48px; opacity: 0.3; margin-bottom: 8px;">&#x1F578;</div>
      <h2>ContractOS TrustGraph</h2>
      <p>The <b>TrustGraph</b> is a typed property graph that transforms contracts from static documents into queryable, explainable legal knowledge.</p>
      <p style="font-size: 12px; max-width: 500px;">Every fact is <b>evidence-grounded</b>. Every inference is <b>provenance-tracked</b>. Every answer shows exactly which nodes in the graph were traversed to produce it.</p>
      <div style="display: flex; gap: 24px; margin-top: 8px; font-size: 11px; color: var(--text2);">
        <div style="text-align: center;"><span style="font-size: 20px; display: block; color: var(--green);">&#x1F4C4;</span>Facts</div>
        <div style="text-align: center; color: var(--text2);">&rarr;</div>
        <div style="text-align: center;"><span style="font-size: 20px; display: block; color: var(--orange);">&#x1F4CB;</span>Clauses</div>
        <div style="text-align: center; color: var(--text2);">&rarr;</div>
        <div style="text-align: center;"><span style="font-size: 20px; display: block; color: var(--blue);">&#x1F517;</span>Bindings</div>
        <div style="text-align: center; color: var(--text2);">&rarr;</div>
        <div style="text-align: center;"><span style="font-size: 20px; display: block; color: var(--accent2);">&#x1F4A1;</span>Inferences</div>
      </div>
      <p style="font-size: 12px; color: var(--text2); margin-top: 12px;">Upload a contract in the side panel to build its TrustGraph.</p>
    </div>
    <svg id="graphSvg" style="display: none;"></svg>
    <div class="stats-bar" id="statsBar" style="display: none;"></div>
    <div class="legend" id="legend" style="display: none;">
      <div class="legend-item"><div class="legend-dot" style="background: var(--accent);"></div> Contract</div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--orange);"></div> Clause</div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--green);"></div> Fact</div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--blue);"></div> Binding</div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--pink);"></div> Cross-Ref</div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--yellow); border: 1px solid var(--orange);"></div> Provenance</div>
    </div>
  </div>

  <div class="side-panel" id="sidePanel">
    <!-- 1. Upload Contract -->
    <h3 style="display: flex; align-items: center; gap: 8px;">
      Upload Contract
      <button onclick="clearAllData()" style="margin-left: auto; background: none; border: 1px solid var(--red); color: var(--red); padding: 2px 8px; border-radius: 3px; font-size: 9px; cursor: pointer;" title="Clear all uploaded files and history">Clear All</button>
    </h3>
    <div class="upload-section">
      <div class="file-drop" id="fileDrop" onclick="document.getElementById('fileInput').click()">
        Click to select .docx or .pdf
      </div>
      <input type="file" id="fileInput" accept=".docx,.pdf" onchange="handleFileSelect(this)">
      <button class="upload-btn" id="uploadBtn" onclick="uploadAndVisualize()" disabled>Upload & Visualize</button>
      <div class="or-divider">‚Äî or load existing ‚Äî</div>
      <div class="doc-id-row">
        <input id="docIdInput" placeholder="doc-xxxxxxxxxxxx">
        <button onclick="loadExistingGraph()">Load</button>
      </div>
    </div>

    <hr class="section-divider">

    <!-- 2. Ask a Question -->
    <h3>Ask a Question</h3>
    <div class="qa-section">
      <textarea id="queryInput" placeholder="e.g. What are the termination conditions?&#10;Who are the parties?&#10;What is the notice period?"></textarea>
      <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 6px;">
        <label style="font-size: 10px; color: var(--text2); white-space: nowrap;">Scope:</label>
        <select id="queryScope" style="flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 4px 6px; color: var(--text); font-size: 10px;">
          <option value="current">Current Document</option>
          <option value="all">All Uploaded Documents</option>
        </select>
      </div>
      <button class="ask-btn" id="askBtn" onclick="askQuestion()" disabled>Ask with FAISS Semantic Search</button>
    </div>
    <div id="answerPanel" style="display: none;"></div>

    <hr class="section-divider">

    <!-- 2b. Chat History -->
    <h3 style="display: flex; align-items: center; gap: 8px;">
      Chat History <span id="historyCount" style="font-size: 10px; color: var(--text2); font-weight: 400;"></span>
      <button onclick="clearChatHistory()" style="margin-left: auto; background: none; border: 1px solid var(--border); color: var(--text2); padding: 2px 8px; border-radius: 3px; font-size: 9px; cursor: pointer;" title="Clear chat history">Clear</button>
    </h3>
    <div id="chatHistory" style="max-height: 280px; overflow-y: auto;">
      <p style="font-size: 11px; color: var(--text2);">No queries yet.</p>
    </div>

    <hr class="section-divider">

    <!-- 3. Node Inspector -->
    <div id="nodeDetail">
      <h3>Node Inspector</h3>
      <p style="font-size: 11px; color: var(--text2);">Click a node in the graph to inspect it.</p>
    </div>
    <div id="traversalPanel" style="display: none;">
      <h3>Graph Traversal</h3>
      <div id="traversalSteps"></div>
    </div>

    <hr class="section-divider">

    <!-- 4. What is TrustGraph -->
    <h3>What is TrustGraph?</h3>
    <div class="algo-section">
      <h4>Graph-Powered Context Harness</h4>
      <p>The <b>TrustGraph</b> is ContractOS's core intelligence layer ‚Äî a <b>typed property graph</b> that stores every extracted fact with full provenance. Unlike flat text search, the TrustGraph preserves <b>relationships between entities</b>, enabling multi-hop reasoning across clauses, definitions, and cross-references.</p>
      <p style="margin-top: 6px;">Inspired by <a href="https://trustgraph.ai/" target="_blank" style="color: var(--accent2);">TrustGraph.ai</a>'s vision of graph-powered context for AI agents ‚Äî every response is driven by connected, verifiable context rather than guessing from flat text.</p>
    </div>
    <div class="algo-section">
      <h4>TrustGraph Ontology</h4>
      <p style="margin-bottom: 4px;"><b>8 Entity Types:</b></p>
      <p style="padding-left: 8px; font-size: 10px;">
        <span style="color: var(--accent);">&#x25CF;</span> <b>Contract</b> ‚Äî root document node<br>
        <span style="color: var(--orange);">&#x25CF;</span> <b>Clause</b> ‚Äî classified sections (termination, payment, etc.)<br>
        <span style="color: var(--green);">&#x25CF;</span> <b>Fact</b> ‚Äî evidence-grounded text spans with char offsets<br>
        <span style="color: var(--blue);">&#x25CF;</span> <b>Binding</b> ‚Äî entity aliases ("Buyer" ‚Üí "Alpha Corp")<br>
        <span style="color: var(--pink);">&#x25CF;</span> <b>CrossReference</b> ‚Äî inter-clause links<br>
        <span style="color: var(--teal);">&#x25CF;</span> <b>ClauseFactSlot</b> ‚Äî mandatory facts per clause type<br>
        <span style="color: var(--accent2);">&#x25CF;</span> <b>Inference</b> ‚Äî derived claims with confidence<br>
        <span style="color: var(--text2);">&#x25CF;</span> <b>ReasoningSession</b> ‚Äî persisted Q&A with provenance
      </p>
      <p style="margin-top: 6px;"><b>5 Relationship Types:</b></p>
      <p style="padding-left: 8px; font-size: 10px;">
        <code>contains</code> Contract‚ÜíClause‚ÜíFact &nbsp;
        <code>binds_to</code> Fact‚ÜíBinding<br>
        <code>cross_references</code> Clause‚ÜíClause &nbsp;
        <code>fills</code> Fact‚ÜíSlot<br>
        <code>supports</code> Fact‚ÜíInference (evidence chain)
      </p>
    </div>

    <hr class="section-divider">

    <!-- 5. How Indexing Works -->
    <h3>Indexing Pipeline</h3>
    <div class="algo-section">
      <h4>Stage 1: Extraction (<1s, zero LLM)</h4>
      <div class="pipeline" id="pipelineViz">
        <div class="pipeline-step"><span class="step-num">1</span> Parse document (docx/pdf) <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">2</span> Regex pattern extraction <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">3</span> Fact generation <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">4</span> Entity alias detection <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">5</span> Clause classification <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">6</span> Cross-reference linking <span class="step-time"></span></div>
        <div class="pipeline-step"><span class="step-num">7</span> Fact slot validation <span class="step-time"></span></div>
      </div>
    </div>
    <div class="algo-section">
      <h4>Stage 2: FAISS Vector Indexing</h4>
      <p>Every fact, clause, and binding is embedded with <code>all-MiniLM-L6-v2</code> (384-dim) into a <b>FAISS IndexFlatIP</b>. Queries retrieve the top-k semantically similar chunks in &lt;5ms.</p>
    </div>
    <div class="algo-section">
      <h4>Query Provenance</h4>
      <p>When answered, the <b style="color: var(--yellow);">yellow provenance path</b> on the graph shows exactly which facts FAISS retrieved and the LLM cited. Click any provenance node to zoom to it.</p>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip" style="display: none;"></div>

<script>
const BASE = window.location.origin;
const NODE_COLORS = {
  contract: '#6c5ce7',
  clause: '#fdcb6e',
  fact: '#00b894',
  binding: '#74b9ff',
  cross_reference: '#fd79a8',
};
const NODE_SIZES = {
  contract: 28,
  clause: 16,
  fact: 8,
  binding: 12,
  cross_reference: 10,
};

let graphData = null;
let simulation = null;
let svg, g, zoom;
let selectedNode = null;
let selectedFile = null;
let currentDocumentId = null;
let uploadedDocIds = [];  // All uploaded document IDs (for multi-doc)
let currentLinks = [];   // D3 link data (for traversal)
let currentNodeMap = null; // Map of id -> node

// ‚îÄ‚îÄ Upload & Load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function handleFileSelect(input) {
  if (input.files.length > 0) {
    selectedFile = input.files[0];
    const drop = document.getElementById('fileDrop');
    drop.textContent = selectedFile.name;
    drop.classList.add('has-file');
    document.getElementById('uploadBtn').disabled = false;
  }
}

async function uploadAndVisualize() {
  if (!selectedFile) return;
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Uploading & Indexing...';
  animatePipeline();

  const fd = new FormData();
  fd.append('file', selectedFile);

  try {
    const resp = await fetch(BASE + '/contracts/upload', { method: 'POST', body: fd });
    if (!resp.ok) throw new Error('Upload failed: ' + resp.status);
    const data = await resp.json();
    if (data.document_id) {
      currentDocumentId = data.document_id;
      if (!uploadedDocIds.includes(data.document_id)) {
        uploadedDocIds.push(data.document_id);
      }
      document.getElementById('docBadge').style.display = 'inline';
      document.getElementById('docBadge').textContent = uploadedDocIds.length > 1
        ? `${uploadedDocIds.length} docs loaded`
        : data.document_id;
      document.getElementById('askBtn').disabled = false;
      // Update scope selector
      if (uploadedDocIds.length > 1) {
        document.getElementById('queryScope').querySelector('option[value="all"]').textContent =
          `All ${uploadedDocIds.length} Documents`;
      }
      // Automatically load the TrustGraph visualization
      await loadGraph(data.document_id);
      loadChatHistory();
    }
  } catch (err) {
    alert('Upload failed: ' + err.message);
  }
  btn.disabled = false;
  btn.textContent = 'Upload & Visualize';
}

async function loadExistingGraph() {
  const docId = document.getElementById('docIdInput').value.trim();
  if (!docId) return;
  currentDocumentId = docId;
  if (!uploadedDocIds.includes(docId)) {
    uploadedDocIds.push(docId);
  }
  document.getElementById('docBadge').style.display = 'inline';
  document.getElementById('docBadge').textContent = docId;
  document.getElementById('askBtn').disabled = false;
  await loadGraph(docId);
  loadChatHistory();
}

function animatePipeline() {
  const steps = document.querySelectorAll('.pipeline-step');
  const times = [120, 45, 30, 25, 15, 20, 10];
  steps.forEach((step, i) => {
    setTimeout(() => {
      step.classList.add('active');
      step.querySelector('.step-time').textContent = times[i] + 'ms';
    }, i * 200);
  });
}

// ‚îÄ‚îÄ Graph Loading & Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadGraph(documentId) {
  try {
    const resp = await fetch(BASE + '/contracts/' + documentId + '/graph');
    if (!resp.ok) throw new Error('Graph not found (HTTP ' + resp.status + ')');
    graphData = await resp.json();
    renderGraph(graphData);
  } catch (err) {
    alert('Failed to load graph: ' + err.message);
  }
}

function renderGraph(data) {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('graphSvg').style.display = 'block';
  document.getElementById('statsBar').style.display = 'flex';
  document.getElementById('legend').style.display = 'flex';

  // Stats
  const s = data.summary;
  document.getElementById('statsBar').innerHTML = `
    <div class="stat"><span class="stat-value">${s.total_facts}</span><span class="stat-label">Facts</span></div>
    <div class="stat"><span class="stat-value">${s.total_clauses}</span><span class="stat-label">Clauses</span></div>
    <div class="stat"><span class="stat-value">${s.total_bindings}</span><span class="stat-label">Bindings</span></div>
    <div class="stat"><span class="stat-value">${s.total_cross_references}</span><span class="stat-label">Cross-Refs</span></div>
    <div class="stat"><span class="stat-value">${data.nodes.length}</span><span class="stat-label">Nodes</span></div>
    <div class="stat"><span class="stat-value">${data.edges.length}</span><span class="stat-label">Edges</span></div>
  `;

  animatePipeline();

  // Prepare D3 data
  const nodes = data.nodes.map(n => ({
    ...n,
    radius: NODE_SIZES[n.type] || 8,
    color: NODE_COLORS[n.type] || '#8b90a0',
  }));

  currentNodeMap = new Map(nodes.map(n => [n.id, n]));
  const links = data.edges
    .filter(e => currentNodeMap.has(e.source) && currentNodeMap.has(e.target))
    .map(e => ({ ...e }));
  currentLinks = links;

  // Setup SVG
  const container = document.getElementById('graph-container');
  const width = container.clientWidth;
  const height = container.clientHeight;

  svg = d3.select('#graphSvg');
  svg.selectAll('*').remove();

  // Defs for arrow markers
  const defs = svg.append('defs');
  Object.entries(NODE_COLORS).forEach(([type, color]) => {
    defs.append('marker')
      .attr('id', 'arrow-' + type)
      .attr('viewBox', '0 -5 10 10')
      .attr('refX', 20)
      .attr('refY', 0)
      .attr('markerWidth', 6)
      .attr('markerHeight', 6)
      .attr('orient', 'auto')
      .append('path')
      .attr('d', 'M0,-5L10,0L0,5')
      .attr('fill', color)
      .attr('opacity', 0.5);
  });
  // Provenance arrow
  defs.append('marker')
    .attr('id', 'arrow-provenance')
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 20)
    .attr('refY', 0)
    .attr('markerWidth', 8)
    .attr('markerHeight', 8)
    .attr('orient', 'auto')
    .append('path')
    .attr('d', 'M0,-5L10,0L0,5')
    .attr('fill', '#ffeaa7')
    .attr('opacity', 0.9);

  zoom = d3.zoom()
    .scaleExtent([0.1, 5])
    .on('zoom', (event) => g.attr('transform', event.transform));
  svg.call(zoom);

  g = svg.append('g');

  // Links
  const link = g.append('g').attr('class', 'links-group')
    .selectAll('line')
    .data(links)
    .join('line')
    .attr('stroke', d => {
      const targetNode = currentNodeMap.get(typeof d.target === 'object' ? d.target.id : d.target);
      return targetNode ? targetNode.color : '#2e3345';
    })
    .attr('stroke-opacity', 0.25)
    .attr('stroke-width', 1)
    .attr('marker-end', d => {
      const targetNode = currentNodeMap.get(typeof d.target === 'object' ? d.target.id : d.target);
      return targetNode ? 'url(#arrow-' + targetNode.type + ')' : '';
    });

  // Provenance overlay group (drawn on top)
  g.append('g').attr('class', 'provenance-overlay');

  // Nodes
  const node = g.append('g').attr('class', 'nodes-group')
    .selectAll('circle')
    .data(nodes)
    .join('circle')
    .attr('r', d => d.radius)
    .attr('fill', d => d.color)
    .attr('stroke', 'none')
    .attr('cursor', 'pointer')
    .call(d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended));

  // Labels for clauses and contract
  const label = g.append('g').attr('class', 'labels-group')
    .selectAll('text')
    .data(nodes.filter(n => n.type === 'contract' || n.type === 'clause'))
    .join('text')
    .attr('font-size', d => d.type === 'contract' ? 13 : 10)
    .attr('fill', d => d.color)
    .attr('text-anchor', 'middle')
    .attr('dy', d => d.radius + 14)
    .text(d => d.label.length > 30 ? d.label.slice(0, 30) + '...' : d.label);

  // Tooltip
  const tooltip = document.getElementById('tooltip');
  node.on('mouseover', (event, d) => {
    tooltip.style.display = 'block';
    tooltip.style.left = (event.pageX + 12) + 'px';
    tooltip.style.top = (event.pageY - 12) + 'px';
    tooltip.innerHTML = `<b style="color: ${d.color}">${d.type.toUpperCase()}</b><br>${d.label}`;

    const connectedIds = new Set();
    links.forEach(l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      if (sid === d.id) connectedIds.add(tid);
      if (tid === d.id) connectedIds.add(sid);
    });
    connectedIds.add(d.id);

    node.attr('opacity', n => connectedIds.has(n.id) ? 1 : 0.15);
    link.attr('stroke-opacity', l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      return connectedIds.has(sid) && connectedIds.has(tid) ? 0.6 : 0.05;
    });
    label.attr('opacity', n => connectedIds.has(n.id) ? 1 : 0.15);
  })
  .on('mousemove', (event) => {
    tooltip.style.left = (event.pageX + 12) + 'px';
    tooltip.style.top = (event.pageY - 12) + 'px';
  })
  .on('mouseout', () => {
    tooltip.style.display = 'none';
    node.attr('opacity', 1);
    link.attr('stroke-opacity', 0.25);
    label.attr('opacity', 1);
  })
  .on('click', (event, d) => {
    selectedNode = d;
    showNodeDetail(d);
    showTraversal(d, links, currentNodeMap);
  });

  // Simulation
  simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
      const sourceNode = typeof d.source === 'object' ? d.source : currentNodeMap.get(d.source);
      if (sourceNode && sourceNode.type === 'contract') return 150;
      return 60;
    }))
    .force('charge', d3.forceManyBody().strength(d => d.type === 'contract' ? -400 : d.type === 'clause' ? -150 : -40))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(d => d.radius + 4))
    .on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);
      label
        .attr('x', d => d.x)
        .attr('y', d => d.y);
      // Update provenance overlay lines
      g.select('.provenance-overlay').selectAll('line')
        .attr('x1', d => { const n = currentNodeMap.get(d.source); return n ? n.x : 0; })
        .attr('y1', d => { const n = currentNodeMap.get(d.source); return n ? n.y : 0; })
        .attr('x2', d => { const n = currentNodeMap.get(d.target); return n ? n.x : 0; })
        .attr('y2', d => { const n = currentNodeMap.get(d.target); return n ? n.y : 0; });
    });

  // Auto-fit after stabilization
  setTimeout(() => {
    const bounds = g.node().getBBox();
    const fullWidth = bounds.width || 1;
    const fullHeight = bounds.height || 1;
    const midX = bounds.x + fullWidth / 2;
    const midY = bounds.y + fullHeight / 2;
    const scale = 0.85 / Math.max(fullWidth / width, fullHeight / height);
    const translate = [width / 2 - scale * midX, height / 2 - scale * midY];
    svg.transition().duration(750).call(
      zoom.transform,
      d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
    );
  }, 2000);
}

// ‚îÄ‚îÄ Q&A with Provenance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function askQuestion() {
  const question = document.getElementById('queryInput').value.trim();
  if (!question) {
    alert('Please enter a question.');
    return;
  }
  if (uploadedDocIds.length === 0) {
    alert('Please upload a document first.');
    return;
  }

  const scope = document.getElementById('queryScope').value;
  const btn = document.getElementById('askBtn');
  const panel = document.getElementById('answerPanel');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Searching with FAISS...';
  panel.style.display = 'block';
  panel.innerHTML = '<div style="padding: 12px; text-align: center;"><span class="spinner"></span> <span style="color: var(--text2); font-size: 12px;">FAISS semantic retrieval ‚Üí LLM reasoning...</span></div>';

  // Build request body ‚Äî single or multi-doc
  let body;
  if (scope === 'all' && uploadedDocIds.length > 1) {
    body = { question, document_ids: uploadedDocIds };
  } else {
    body = { question, document_id: currentDocumentId };
  }

  try {
    const resp = await fetch(BASE + '/query/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!resp.ok) {
      const errData = await resp.json().catch(() => ({}));
      throw new Error(errData.detail || 'Query failed: ' + resp.status);
    }
    const data = await resp.json();
    renderAnswer(data);
    loadChatHistory(); // Refresh history
  } catch (err) {
    panel.innerHTML = `<div class="answer-card" style="border-color: var(--red);"><div style="color: var(--red); font-size: 13px;">Error: ${err.message}</div></div>`;
  }

  btn.disabled = false;
  btn.textContent = 'Ask with FAISS Semantic Search';
}

async function loadChatHistory() {
  try {
    const resp = await fetch(BASE + '/query/history?limit=30');
    if (!resp.ok) return;
    const history = await resp.json();
    const el = document.getElementById('chatHistory');
    const countEl = document.getElementById('historyCount');
    if (history.length === 0) {
      el.innerHTML = '<p style="font-size: 11px; color: var(--text2);">No queries yet. Ask a question above.</p>';
      countEl.textContent = '';
      return;
    }
    countEl.textContent = `(${history.length})`;
    el.innerHTML = history.map((h, i) => {
      const confPct = h.confidence ? (h.confidence * 100).toFixed(0) + '%' : '';
      const answerPreview = h.answer ? h.answer.substring(0, 120) + (h.answer.length > 120 ? '...' : '') : '';
      const docCount = h.document_ids ? h.document_ids.length : 0;
      const isExpanded = false;
      return `
      <div class="history-item" style="padding: 8px 10px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; font-size: 11px;"
           onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='transparent'"
           onclick="toggleHistoryItem(this)">
        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
          <span style="color: ${h.status === 'completed' ? 'var(--green)' : 'var(--orange)'}; font-size: 10px;">${h.status === 'completed' ? '‚óè' : '‚óã'}</span>
          <span style="color: var(--text); font-weight: 500; flex: 1;">${h.question}</span>
        </div>
        <div class="history-answer" style="display: none; padding: 6px 0 4px 16px; color: var(--text2); font-size: 10px; line-height: 1.5; border-left: 2px solid var(--accent); margin: 4px 0;">
          ${answerPreview || '<i>No answer</i>'}
        </div>
        <div style="display: flex; gap: 8px; color: var(--text2); font-size: 9px; padding-left: 16px;">
          ${docCount > 1 ? `<span style="color: var(--blue);">${docCount} docs</span>` : ''}
          ${confPct ? `<span>${confPct}</span>` : ''}
          ${h.generation_time_ms ? `<span>${h.generation_time_ms}ms</span>` : ''}
        </div>
      </div>`;
    }).join('');
  } catch (e) { /* ignore */ }
}

function toggleHistoryItem(el) {
  const answerDiv = el.querySelector('.history-answer');
  if (answerDiv) {
    const isHidden = answerDiv.style.display === 'none';
    answerDiv.style.display = isHidden ? 'block' : 'none';
  }
  // Also populate the query input for re-asking
  const questionEl = el.querySelector('span[style*="font-weight: 500"]');
  if (questionEl) {
    document.getElementById('queryInput').value = questionEl.textContent;
  }
}

async function clearChatHistory() {
  if (!confirm('Clear all chat history?')) return;
  try {
    const resp = await fetch(BASE + '/query/history', { method: 'DELETE' });
    if (resp.ok) loadChatHistory();
  } catch (e) { /* ignore */ }
}

async function clearAllData() {
  if (!confirm('Clear ALL uploaded contracts, facts, and chat history? This cannot be undone.')) return;
  try {
    await fetch(BASE + '/contracts/clear', { method: 'DELETE' });
    await fetch(BASE + '/query/history', { method: 'DELETE' });
    // Reset UI state
    currentDocumentId = null;
    uploadedDocIds = [];
    graphData = null;
    document.getElementById('docBadge').style.display = 'none';
    document.getElementById('askBtn').disabled = true;
    document.getElementById('answerPanel').style.display = 'none';
    document.getElementById('graphSvg').style.display = 'none';
    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('statsBar').style.display = 'none';
    document.getElementById('legend').style.display = 'none';
    loadChatHistory();
  } catch (e) { /* ignore */ }
}

function renderAnswer(data) {
  const panel = document.getElementById('answerPanel');
  const conf = data.confidence ? `${data.confidence.label} (${data.confidence.score})` : 'N/A';
  const retrieval = data.retrieval_method === 'faiss_semantic'
    ? '<span class="badge-green">FAISS Semantic</span>'
    : '<span class="badge-orange">Full Scan</span>';

  // Build provenance HTML
  let provenanceHTML = '';
  if (data.provenance && data.provenance.nodes && data.provenance.nodes.length > 0) {
    provenanceHTML = '<div class="provenance-chain"><div class="chain-title">Provenance Chain (' + data.provenance.node_count + ' nodes)</div>';
    data.provenance.nodes.forEach((node, idx) => {
      const icon = node.icon || (node.node_type === 'fact' ? 'üìÑ' : node.node_type === 'inference' ? 'üí°' : 'üîó');
      const typeColor = node.node_type === 'fact' ? 'var(--green)' : node.node_type === 'inference' ? 'var(--orange)' : 'var(--blue)';
      provenanceHTML += `
        <div class="provenance-node" id="prov-${idx}" onclick="focusProvenanceNode('${node.reference_id}', ${idx})">
          <span class="prov-icon">${icon}</span>
          <div class="prov-body">
            <span class="prov-type" style="color: ${typeColor};">${node.node_type}</span>:
            <span class="prov-summary">${node.summary}</span>
            ${node.document_location ? `<div class="prov-location">üìç ${node.document_location}</div>` : ''}
          </div>
        </div>`;
    });
    if (data.provenance.reasoning_summary) {
      provenanceHTML += `<div class="reasoning-box"><b>Reasoning Chain:</b><br>${data.provenance.reasoning_summary}</div>`;
    }
    provenanceHTML += '</div>';
  }

  panel.innerHTML = `
    <div class="answer-card">
      <div class="answer-text">${data.answer}</div>
      <div class="answer-meta">
        <span>Confidence: <b>${conf}</b></span>
        <span>Retrieval: ${retrieval}</span>
        ${data.generation_time_ms ? `<span>${data.generation_time_ms}ms</span>` : ''}
        ${data.facts_referenced ? `<span>${data.facts_referenced.length} facts cited</span>` : ''}
      </div>
    </div>
    ${provenanceHTML}
  `;

  // Highlight provenance on the graph
  if (data.facts_referenced && data.facts_referenced.length > 0) {
    highlightProvenanceOnGraph(data.facts_referenced, data.provenance);
  }
}

function highlightProvenanceOnGraph(factIds, provenance) {
  if (!graphData || !currentNodeMap) return;

  const factSet = new Set(factIds);

  // Find all provenance-related node IDs (facts + their parent clauses)
  const provenanceNodeIds = new Set(factIds);
  // Walk edges to find parent clauses of provenance facts
  currentLinks.forEach(l => {
    const sid = typeof l.source === 'object' ? l.source.id : l.source;
    const tid = typeof l.target === 'object' ? l.target.id : l.target;
    if (factSet.has(tid)) {
      const sourceNode = currentNodeMap.get(sid);
      if (sourceNode && (sourceNode.type === 'clause' || sourceNode.type === 'contract')) {
        provenanceNodeIds.add(sid);
      }
    }
    if (factSet.has(sid)) {
      const targetNode = currentNodeMap.get(tid);
      if (targetNode && (targetNode.type === 'clause' || targetNode.type === 'contract')) {
        provenanceNodeIds.add(tid);
      }
    }
  });

  // Dim all nodes, highlight provenance
  d3.selectAll('.nodes-group circle')
    .attr('opacity', d => provenanceNodeIds.has(d.id) ? 1 : 0.12)
    .attr('stroke', d => factSet.has(d.id) ? '#ffeaa7' : provenanceNodeIds.has(d.id) ? '#fff' : 'none')
    .attr('stroke-width', d => factSet.has(d.id) ? 4 : provenanceNodeIds.has(d.id) ? 2 : 0);

  // Dim non-relevant edges
  d3.selectAll('.links-group line')
    .attr('stroke-opacity', l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      return provenanceNodeIds.has(sid) && provenanceNodeIds.has(tid) ? 0.7 : 0.03;
    })
    .attr('stroke-width', l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      return provenanceNodeIds.has(sid) && provenanceNodeIds.has(tid) ? 2 : 1;
    });

  d3.selectAll('.labels-group text')
    .attr('opacity', d => provenanceNodeIds.has(d.id) ? 1 : 0.1);

  // Draw provenance traversal lines (yellow overlay connecting provenance facts through their clauses)
  const overlay = g.select('.provenance-overlay');
  overlay.selectAll('*').remove();

  // Build provenance path: for each pair of consecutive provenance facts, draw through their shared clause
  const provenanceEdges = [];
  const factArray = Array.from(factSet);
  factArray.forEach(fid => {
    // Find clause parent of this fact
    currentLinks.forEach(l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      if (tid === fid && provenanceNodeIds.has(sid)) {
        provenanceEdges.push({ source: sid, target: fid });
      }
      if (sid === fid && provenanceNodeIds.has(tid)) {
        provenanceEdges.push({ source: fid, target: tid });
      }
    });
  });

  // Draw yellow provenance edges with animation
  const provLines = overlay.selectAll('line')
    .data(provenanceEdges)
    .join('line')
    .attr('stroke', '#ffeaa7')
    .attr('stroke-width', 3)
    .attr('stroke-opacity', 0)
    .attr('stroke-dasharray', '8,4')
    .attr('marker-end', 'url(#arrow-provenance)')
    .attr('x1', d => { const n = currentNodeMap.get(d.source); return n ? n.x : 0; })
    .attr('y1', d => { const n = currentNodeMap.get(d.source); return n ? n.y : 0; })
    .attr('x2', d => { const n = currentNodeMap.get(d.target); return n ? n.x : 0; })
    .attr('y2', d => { const n = currentNodeMap.get(d.target); return n ? n.y : 0; });

  // Animate provenance edges appearing sequentially
  provLines.transition()
    .delay((d, i) => i * 150)
    .duration(400)
    .attr('stroke-opacity', 0.85);

  // Add pulsing glow to provenance fact nodes
  d3.selectAll('.nodes-group circle')
    .filter(d => factSet.has(d.id))
    .each(function() {
      const circle = d3.select(this);
      const origR = +circle.attr('r');
      (function pulse() {
        circle.transition().duration(800).attr('r', origR + 3)
          .transition().duration(800).attr('r', origR)
          .on('end', pulse);
      })();
    });
}

function focusProvenanceNode(nodeId, idx) {
  // Highlight the clicked provenance node in the side panel
  document.querySelectorAll('.provenance-node').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('prov-' + idx);
  if (el) el.classList.add('active');

  // Highlight on graph with yellow ring
  d3.selectAll('.nodes-group circle')
    .attr('stroke', d => d.id === nodeId ? '#ffeaa7' : 'none')
    .attr('stroke-width', d => d.id === nodeId ? 5 : 0)
    .attr('opacity', d => d.id === nodeId ? 1 : 0.15);

  // Zoom to the node
  if (currentNodeMap) {
    const n = currentNodeMap.get(nodeId);
    if (n && n.x !== undefined) {
      const container = document.getElementById('graph-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      svg.transition().duration(600).call(
        zoom.transform,
        d3.zoomIdentity.translate(width / 2 - n.x * 2, height / 2 - n.y * 2).scale(2)
      );
    }
  }

  // Show node detail
  if (graphData) {
    const n = graphData.nodes.find(n => n.id === nodeId);
    if (n) {
      showNodeDetail({ ...n, color: NODE_COLORS[n.type], radius: NODE_SIZES[n.type] });
    }
  }
}

// ‚îÄ‚îÄ Node Inspector & Traversal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showNodeDetail(node) {
  const detail = document.getElementById('nodeDetail');
  const color = NODE_COLORS[node.type] || '#8b90a0';
  let metaHTML = '';
  if (node.metadata) {
    Object.entries(node.metadata).forEach(([k, v]) => {
      if (v !== null && v !== undefined) {
        const val = typeof v === 'object' ? JSON.stringify(v) : String(v);
        metaHTML += `<div class="meta-row"><span class="meta-key">${k}</span><span class="meta-value" title="${val}">${val}</span></div>`;
      }
    });
  }
  detail.innerHTML = `
    <h3>Node Inspector</h3>
    <div class="node-detail">
      <span class="type-badge" style="background: ${color}22; color: ${color};">${node.type}</span>
      <div class="label">${node.label}</div>
      <div class="meta-row"><span class="meta-key">ID</span><span class="meta-value">${node.id}</span></div>
      ${metaHTML}
    </div>
  `;
}

function showTraversal(node, links, nodeMap) {
  const panel = document.getElementById('traversalPanel');
  const steps = document.getElementById('traversalSteps');
  panel.style.display = 'block';

  // BFS from selected node, max depth 2
  const visited = new Set([node.id]);
  const queue = [{ id: node.id, depth: 0, path: [node] }];
  const paths = [];

  while (queue.length > 0) {
    const { id, depth, path } = queue.shift();
    if (depth > 0) paths.push(path);
    if (depth >= 2) continue;

    links.forEach(l => {
      const sid = typeof l.source === 'object' ? l.source.id : l.source;
      const tid = typeof l.target === 'object' ? l.target.id : l.target;
      let nextId = null;
      if (sid === id && !visited.has(tid)) nextId = tid;
      if (tid === id && !visited.has(sid)) nextId = sid;
      if (nextId) {
        visited.add(nextId);
        const nextNode = nodeMap.get(nextId);
        if (nextNode) {
          const rel = l.relationship || 'connected';
          queue.push({ id: nextId, depth: depth + 1, path: [...path, { rel, node: nextNode }] });
        }
      }
    });
  }

  let html = '';
  paths.slice(0, 12).forEach(path => {
    const last = path[path.length - 1];
    const n = last.node || last;
    const rel = last.rel || '';
    const color = NODE_COLORS[n.type] || '#8b90a0';
    html += `
      <div class="traversal-step" onclick="highlightNode('${n.id}')">
        <div class="step-icon" style="background: ${color}22; color: ${color};">${n.type[0].toUpperCase()}</div>
        <div style="font-size: 12px;">
          <span style="font-weight: 600;">${rel}</span> ‚Üí
          <span style="color: ${color}">${n.type}</span>:
          <span style="color: var(--text2);">${(n.label || '').slice(0, 60)}</span>
        </div>
      </div>`;
  });

  if (paths.length === 0) {
    html = '<p style="font-size: 11px; color: var(--text2);">No connections found.</p>';
  }
  steps.innerHTML = html;
}

function highlightNode(nodeId) {
  d3.selectAll('.nodes-group circle')
    .attr('stroke', d => d.id === nodeId ? '#fff' : 'none')
    .attr('stroke-width', d => d.id === nodeId ? 3 : 0);

  if (graphData) {
    const n = graphData.nodes.find(n => n.id === nodeId);
    if (n) showNodeDetail({ ...n, color: NODE_COLORS[n.type], radius: NODE_SIZES[n.type] });
  }
}

// ‚îÄ‚îÄ Filter, Layout, Zoom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function applyFilter() {
  const filter = document.getElementById('filterType').value;
  if (!graphData) return;

  d3.selectAll('.nodes-group circle').attr('opacity', d => {
    if (filter === 'all') return 1;
    if (filter === 'no-clause-text') {
      return (d.metadata && d.metadata.fact_type === 'clause_text') ? 0.05 : 1;
    }
    return d.type === filter ? 1 : 0.1;
  });
}

function changeLayout() {
  if (!simulation || !graphData) return;
  const layout = document.getElementById('layoutType').value;
  const container = document.getElementById('graph-container');
  const width = container.clientWidth;
  const height = container.clientHeight;

  if (layout === 'radial') {
    simulation.force('center', null);
    simulation.force('radial', d3.forceRadial(d => {
      if (d.type === 'contract') return 0;
      if (d.type === 'clause') return 150;
      if (d.type === 'binding') return 250;
      return 300;
    }, width / 2, height / 2).strength(0.8));
  } else if (layout === 'hierarchy') {
    simulation.force('radial', null);
    simulation.force('center', null);
    simulation.force('y', d3.forceY(d => {
      if (d.type === 'contract') return 80;
      if (d.type === 'clause') return 200;
      if (d.type === 'binding') return 320;
      return 440;
    }).strength(0.5));
    simulation.force('x', d3.forceX(width / 2).strength(0.05));
  } else {
    simulation.force('radial', null);
    simulation.force('y', null);
    simulation.force('x', null);
    simulation.force('center', d3.forceCenter(width / 2, height / 2));
  }
  simulation.alpha(0.8).restart();
}

function resetView() {
  // Reset zoom
  if (svg && zoom) {
    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
  }
  // Clear provenance overlay
  if (g) {
    g.select('.provenance-overlay').selectAll('*').remove();
  }
  // Reset node styles
  d3.selectAll('.nodes-group circle')
    .attr('opacity', 1)
    .attr('stroke', 'none')
    .attr('stroke-width', 0);
  d3.selectAll('.links-group line')
    .attr('stroke-opacity', 0.25)
    .attr('stroke-width', 1);
  d3.selectAll('.labels-group text')
    .attr('opacity', 1);
}

// ‚îÄ‚îÄ Drag handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function dragstarted(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}
function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}
function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}
</script>
</body>
</html>
