###############################################################################
# ContractOS — Production Compose
#
# Container engine agnostic — works with:
#   Docker Desktop, Rancher Desktop (nerdctl), Podman, or any OCI runtime
#
# Usage:
#   1. Copy .env.example to .env and fill in your Anthropic credentials
#   2. docker compose up --build -d       (or: nerdctl compose / podman-compose)
#   3. Open http://<host-ip>:8742/demo/copilot.html  (Copilot UI)
#   4. MCP endpoint: http://<host-ip>:8743/mcp       (AI assistant integration)
#
# To view logs:   docker compose logs -f contractos
# To stop:        docker compose down
# To reset data:  docker compose down -v   (removes SQLite volume)
#
# Features included:
#   - MCP server (13 tools, 10 resources, 5 prompts) for Cursor/Claude Desktop
#   - SSE streaming endpoints (progressive reasoning)
#   - Obligation extraction & risk memo generation
#   - Playbook review with redline generation
#   - NDA triage screening
#   - Hidden fact discovery (LLM-powered)
#   - FAISS semantic search (all-MiniLM-L6-v2 pre-baked)
#   - Draggable/detachable Copilot sidebar
#   - HTML report downloads
###############################################################################

services:
  contractos:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: contractos
    restart: unless-stopped

    ports:
      - "${PORT:-8742}:${PORT:-8742}"           # FastAPI + Copilot UI
      - "${MCP_PORT:-8743}:${MCP_PORT:-8743}"   # MCP Streamable HTTP

    env_file:
      - .env

    environment:
      - PORT=${PORT:-8742}
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      - CONTRACTOS_DB_PATH=/data/.contractos/trustgraph.db
      # Enable MCP HTTP server alongside FastAPI
      - MCP_TRANSPORT=http
      - MCP_PORT=${MCP_PORT:-8743}

    volumes:
      # Persistent SQLite storage — survives container restarts and rebuilds
      - contractos-data:/data/.contractos

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${PORT:-8742}/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

    # Ensure enough resources for sentence-transformers + FAISS + extraction
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  contractos-data:
    driver: local
